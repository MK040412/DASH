<?xml version="1.0" encoding="UTF-8"?>
<mxfile>
<diagram name="PatchMerger Detail" id="patch_merger">
<mxGraphModel dx="1400" dy="1600" grid="1" gridSize="10" guides="1">
<root>
<mxCell id="0"/>
<mxCell id="1" parent="0"/>
<mxCell id="2" value="&lt;b&gt;(a) Spatial Merge 2×2 — Token Count Reduction&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#333333;fontSize=14;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="20" y="10" width="950" height="28" as="geometry"/></mxCell>
<mxCell id="3" value="&lt;b&gt;Input Feature Map&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#333333;fontSize=11;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="45" y="43" width="216" height="22" as="geometry"/></mxCell>
<mxCell id="4" value="(6×6 patches, dim=1152)" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#666;fontSize=9;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="45" y="63" width="216" height="18" as="geometry"/></mxCell>
<mxCell id="5" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="50" y="85" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="6" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="86" y="85" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="7" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="122" y="85" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="8" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="158" y="85" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="9" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="194" y="85" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="10" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="230" y="85" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="11" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="50" y="121" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="12" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="86" y="121" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="13" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="122" y="121" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="14" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="158" y="121" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="15" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="194" y="121" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="16" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="230" y="121" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="17" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="50" y="157" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="18" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="86" y="157" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="19" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#e65100;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="122" y="157" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="20" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#e65100;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="158" y="157" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="21" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="194" y="157" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="22" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="230" y="157" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="23" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="50" y="193" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="24" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="86" y="193" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="25" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#e65100;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="122" y="193" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="26" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#e65100;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="158" y="193" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="27" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="194" y="193" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="28" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="230" y="193" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="29" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="50" y="229" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="30" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="86" y="229" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="31" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="122" y="229" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="32" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="158" y="229" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="33" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="194" y="229" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="34" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="230" y="229" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="35" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="50" y="265" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="36" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="86" y="265" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="37" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="122" y="265" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="38" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="158" y="265" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="39" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="194" y="265" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="40" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=7;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="230" y="265" width="34" height="34" as="geometry"/></mxCell>
<mxCell id="41" value="&lt;b&gt;2×2 block&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#e65100;fontSize=9;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="117" y="305" width="80" height="18" as="geometry"/></mxCell>
<mxCell id="42" value="&lt;b&gt;Merge Operation (per 2×2 block)&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#333333;fontSize=11;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="306" y="70" width="310" height="22" as="geometry"/></mxCell>
<mxCell id="43" value="&lt;b&gt;a&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#e65100;fontSize=14;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="316" y="105" width="41" height="41" as="geometry"/></mxCell>
<mxCell id="44" value="&lt;b&gt;b&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#e65100;fontSize=14;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="360" y="105" width="41" height="41" as="geometry"/></mxCell>
<mxCell id="45" value="&lt;b&gt;c&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#e65100;fontSize=14;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="316" y="149" width="41" height="41" as="geometry"/></mxCell>
<mxCell id="46" value="&lt;b&gt;d&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#e65100;fontSize=14;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="360" y="149" width="41" height="41" as="geometry"/></mxCell>
<mxCell id="47" value="each: (1, 1152)" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#666;fontSize=8;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="311" y="198" width="95" height="16" as="geometry"/></mxCell>
<mxCell id="48" value="→" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#9673a6;fontSize=24;fontStyle=1;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="424" y="120" width="25" height="50" as="geometry"/></mxCell>
<mxCell id="49" value="&lt;b&gt;[ a ‖ b ‖ c ‖ d ]&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="464" y="113" width="180" height="55" as="geometry"/></mxCell>
<mxCell id="50" value="4 × 1152 = &lt;b&gt;4608&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#9673a6;fontSize=10;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="464" y="171" width="180" height="18" as="geometry"/></mxCell>
<mxCell id="51" value="Tensor.view(-1, 4608)" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#666;fontSize=8;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="464" y="189" width="180" height="16" as="geometry"/></mxCell>
<mxCell id="52" value="&lt;b&gt;Merged Tokens&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#333333;fontSize=11;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="684" y="43" width="186" height="22" as="geometry"/></mxCell>
<mxCell id="53" value="(3×3 tokens, dim=3584)" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#666;fontSize=9;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="684" y="63" width="186" height="18" as="geometry"/></mxCell>
<mxCell id="54" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="684" y="85" width="59" height="59" as="geometry"/></mxCell>
<mxCell id="55" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="746" y="85" width="59" height="59" as="geometry"/></mxCell>
<mxCell id="56" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="808" y="85" width="59" height="59" as="geometry"/></mxCell>
<mxCell id="57" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="684" y="147" width="59" height="59" as="geometry"/></mxCell>
<mxCell id="58" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#e65100;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="746" y="147" width="59" height="59" as="geometry"/></mxCell>
<mxCell id="59" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="808" y="147" width="59" height="59" as="geometry"/></mxCell>
<mxCell id="60" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="684" y="209" width="59" height="59" as="geometry"/></mxCell>
<mxCell id="61" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="746" y="209" width="59" height="59" as="geometry"/></mxCell>
<mxCell id="62" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="808" y="209" width="59" height="59" as="geometry"/></mxCell>
<mxCell id="63" value="&lt;b&gt;4× fewer tokens&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#9673a6;fontSize=10;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="694" y="277" width="166" height="20" as="geometry"/></mxCell>
<mxCell id="64" value="spatial_merge_size = 2  ·  N patches → N/4 merged tokens  ·  Tokens reordered to block-major (2×2 groups adjacent in memory)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="40" y="331" width="900" height="34" as="geometry"/></mxCell>
<mxCell id="65" value="&lt;b&gt;(b) Final PatchMerger&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#333333;fontSize=13;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="20" y="400" width="320" height="25" as="geometry"/></mxCell>
<mxCell id="66" value="self.merger  ·  use_postshuffle_norm=False" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#666;fontSize=9;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="20" y="424" width="320" height="16" as="geometry"/></mxCell>
<mxCell id="67" value="After VisionBlock₂₆ (last block) → LLM input" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#1565c0;fontSize=9;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="20" y="440" width="320" height="16" as="geometry"/></mxCell>
<mxCell id="68" value="Input: &lt;b&gt;(N, 1152)&lt;/b&gt;
from VisionBlock₂₆" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="40" y="814" width="280" height="48" as="geometry"/></mxCell>
<mxCell id="69" value="&lt;b&gt;nn.LayerNorm(1152)&lt;/b&gt;
self.norm
❶ Normalize BEFORE merge" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="40" y="752" width="280" height="52" as="geometry"/></mxCell>
<mxCell id="70" value="&lt;b&gt;Tensor.view(-1, 4608)&lt;/b&gt;
Spatial Merge 2×2
(N, 1152) → (N/4, 4608)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="40" y="690" width="280" height="52" as="geometry"/></mxCell>
<mxCell id="71" value="&lt;b&gt;nn.Linear(4608, 4608)&lt;/b&gt;
self.linear_fc1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d6b656;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="40" y="636" width="280" height="44" as="geometry"/></mxCell>
<mxCell id="72" value="&lt;b&gt;nn.GELU()&lt;/b&gt;
self.act_fn" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="40" y="590" width="280" height="36" as="geometry"/></mxCell>
<mxCell id="73" value="&lt;b&gt;nn.Linear(4608, 3584)&lt;/b&gt;
self.linear_fc2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d6b656;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="40" y="536" width="280" height="44" as="geometry"/></mxCell>
<mxCell id="74" value="Output: &lt;b&gt;(N/4, 3584)&lt;/b&gt;
→ LLM token sequence" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="40" y="478" width="280" height="48" as="geometry"/></mxCell>
<mxCell id="75" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="68" target="69"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="76" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="69" target="70"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="77" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="70" target="71"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="78" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="71" target="72"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="79" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="72" target="73"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="80" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="73" target="74"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="81" value="(N, 1152)" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#82b366;fontSize=9;fontStyle=0;align=left;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="328" y="767" width="100" height="16" as="geometry"/></mxCell>
<mxCell id="82" value="&lt;b&gt;(N/4, 4608)&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#9673a6;fontSize=9;fontStyle=0;align=left;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="328" y="705" width="110" height="16" as="geometry"/></mxCell>
<mxCell id="83" value="&lt;b&gt;(N/4, 3584)&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#d6b656;fontSize=9;fontStyle=0;align=left;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="328" y="548" width="110" height="16" as="geometry"/></mxCell>
<mxCell id="84" value="❶ → ❷" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#2e7d32;fontSize=10;fontStyle=1;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="333" y="797" width="60" height="20" as="geometry"/></mxCell>
<mxCell id="85" value="Norm first,
then merge" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#2e7d32;fontSize=8;fontStyle=0;align=left;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="328" y="812" width="110" height="30" as="geometry"/></mxCell>
<mxCell id="86" value="&lt;b&gt;(c) DeepStack PatchMerger&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#333333;fontSize=13;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="440" y="400" width="340" height="25" as="geometry"/></mxCell>
<mxCell id="87" value="deepstack_merger_list[i]  ·  use_postshuffle_norm=True" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#666;fontSize=9;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="440" y="424" width="340" height="16" as="geometry"/></mxCell>
<mxCell id="88" value="At VisionBlock 8, 16, 24 → inject into LLM layers 0, 1, 2" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#c62828;fontSize=9;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="440" y="440" width="340" height="16" as="geometry"/></mxCell>
<mxCell id="89" value="Input: &lt;b&gt;(N, 1152)&lt;/b&gt;
from VisionBlock₈ / ₁₆ / ₂₄" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="460" y="814" width="280" height="48" as="geometry"/></mxCell>
<mxCell id="90" value="&lt;b&gt;Tensor.view(-1, 4608)&lt;/b&gt;
Spatial Merge 2×2
❶ Merge FIRST" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="460" y="752" width="280" height="52" as="geometry"/></mxCell>
<mxCell id="91" value="&lt;b&gt;nn.LayerNorm(4608)&lt;/b&gt;
self.norm (postshuffle)
❷ Normalize AFTER merge" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="460" y="690" width="280" height="52" as="geometry"/></mxCell>
<mxCell id="92" value="&lt;b&gt;nn.Linear(4608, 4608)&lt;/b&gt;
self.linear_fc1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d6b656;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="460" y="636" width="280" height="44" as="geometry"/></mxCell>
<mxCell id="93" value="&lt;b&gt;nn.GELU()&lt;/b&gt;
self.act_fn" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="460" y="590" width="280" height="36" as="geometry"/></mxCell>
<mxCell id="94" value="&lt;b&gt;nn.Linear(4608, 3584)&lt;/b&gt;
self.linear_fc2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d6b656;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="460" y="536" width="280" height="44" as="geometry"/></mxCell>
<mxCell id="95" value="Output: &lt;b&gt;(N/4, 3584)&lt;/b&gt;
→ LLM Layer 0 / 1 / 2 (DeepStack)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#c62828;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="460" y="478" width="280" height="48" as="geometry"/></mxCell>
<mxCell id="96" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="89" target="90"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="97" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="90" target="91"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="98" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="91" target="92"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="99" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="92" target="93"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="100" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="93" target="94"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="101" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="94" target="95"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="102" value="&lt;b&gt;(N/4, 4608)&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#9673a6;fontSize=9;fontStyle=0;align=left;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="748" y="767" width="110" height="16" as="geometry"/></mxCell>
<mxCell id="103" value="(N/4, 4608)" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#82b366;fontSize=9;fontStyle=0;align=left;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="748" y="705" width="100" height="16" as="geometry"/></mxCell>
<mxCell id="104" value="&lt;b&gt;(N/4, 3584)&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#d6b656;fontSize=9;fontStyle=0;align=left;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="748" y="548" width="110" height="16" as="geometry"/></mxCell>
<mxCell id="105" value="❶ → ❷" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#c62828;fontSize=10;fontStyle=1;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="753" y="797" width="60" height="20" as="geometry"/></mxCell>
<mxCell id="106" value="Merge first,
then norm" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#c62828;fontSize=8;fontStyle=0;align=left;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="748" y="812" width="110" height="30" as="geometry"/></mxCell>
<mxCell id="107" value="⚠ Key Difference: Norm placement is SWAPPED
Final: LN(1152) → merge → MLP
DeepStack: merge → LN(4608) → MLP" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3949ab;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="460" y="433" width="280" height="48" as="geometry"/></mxCell>
<mxCell id="108" value="&lt;b&gt;(d) 27-Block ViT Pipeline — Merger Tap Points&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#333333;fontSize=13;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="860" y="400" width="420" height="25" as="geometry"/></mxCell>
<mxCell id="109" value="deepstack_visual_indexes = [8, 16, 24]" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#c62828;fontSize=9;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="860" y="424" width="420" height="16" as="geometry"/></mxCell>
<mxCell id="110" value="&lt;b&gt;PatchEmbed&lt;/b&gt;
Conv3d(3,1152,
kernel=(2,16,16))" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="890" y="890" width="150" height="48" as="geometry"/></mxCell>
<mxCell id="111" value="+ AbsPosEmbed
+ 2D RoPE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="890" y="833" width="150" height="34" as="geometry"/></mxCell>
<mxCell id="112" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="110" target="111"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="113" value="Blocks 0–7
(8× VisionBlock)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e3f2fd;strokeColor=#1565c0;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="890" y="794" width="150" height="50" as="geometry"/></mxCell>
<mxCell id="114" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="111" target="113"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="115" value="&lt;b&gt;Block 8&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#c62828;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="890" y="739" width="150" height="26" as="geometry"/></mxCell>
<mxCell id="116" value="&lt;b&gt;DeepStack
Merger₀
→ LLM L0&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#c62828;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="1080" y="735" width="120" height="34" as="geometry"/></mxCell>
<mxCell id="117" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#c62828;fontSize=9;strokeWidth=2;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="115" target="116"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="118" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="113" target="115"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="119" value="Blocks 9–15
(7× VisionBlock)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e3f2fd;strokeColor=#1565c0;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="890" y="708" width="150" height="49" as="geometry"/></mxCell>
<mxCell id="120" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="115" target="119"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="121" value="&lt;b&gt;Block 16&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#c62828;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="890" y="654" width="150" height="26" as="geometry"/></mxCell>
<mxCell id="122" value="&lt;b&gt;DeepStack
Merger₁
→ LLM L1&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#c62828;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="1080" y="650" width="120" height="34" as="geometry"/></mxCell>
<mxCell id="123" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#c62828;fontSize=9;strokeWidth=2;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="121" target="122"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="124" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="119" target="121"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="125" value="Blocks 17–23
(7× VisionBlock)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e3f2fd;strokeColor=#1565c0;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="890" y="623" width="150" height="49" as="geometry"/></mxCell>
<mxCell id="126" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="121" target="125"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="127" value="&lt;b&gt;Block 24&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#c62828;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="890" y="569" width="150" height="26" as="geometry"/></mxCell>
<mxCell id="128" value="&lt;b&gt;DeepStack
Merger₂
→ LLM L2&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#c62828;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="1080" y="565" width="120" height="34" as="geometry"/></mxCell>
<mxCell id="129" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#c62828;fontSize=9;strokeWidth=2;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="127" target="128"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="130" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="125" target="127"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="131" value="Blocks 25–26
(2× VisionBlock)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e3f2fd;strokeColor=#1565c0;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="890" y="538" width="150" height="26" as="geometry"/></mxCell>
<mxCell id="132" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="127" target="131"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="133" value="&lt;b&gt;Final Merger&lt;/b&gt;
(panel b)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="890" y="507" width="150" height="34" as="geometry"/></mxCell>
<mxCell id="134" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="131" target="133"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="135" value="&lt;b&gt;→ LLM Decoder&lt;/b&gt;
(N/4, 3584)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="890" y="468" width="150" height="34" as="geometry"/></mxCell>
<mxCell id="136" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;strokeColor=#333333;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="133" target="135"><mxGeometry relative="1" as="geometry"/></mxCell>
<mxCell id="137" value="&lt;b&gt;(e) PatchMerger Comparison: Qwen2.5-VL vs Qwen3-VL&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;fontColor=#333333;fontSize=13;fontStyle=0;align=center;verticalAlign=middle;" vertex="1" parent="1"><mxGeometry x="20" y="870" width="750" height="25" as="geometry"/></mxCell>
<mxCell id="138" value="&lt;b&gt;Property&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="902" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="139" value="&lt;b&gt;Qwen2.5-VL&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="902" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="140" value="&lt;b&gt;Qwen3-VL Final&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="902" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="141" value="&lt;b&gt;Qwen3-VL DeepStack&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="902" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="142" value="Class" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=8;fontStyle=1;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="932" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="143" value="Qwen2_5_VLPatchMerger" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="932" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="144" value="Qwen3VLVisionPatchMerger" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="932" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="145" value="Qwen3VLVisionPatchMerger" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="932" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="146" value="Count" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=8;fontStyle=1;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="962" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="147" value="1 merger only" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="962" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="148" value="1 (self.merger)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="962" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="149" value="3 (deepstack_merger_list)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="962" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="150" value="Norm Type" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=8;fontStyle=1;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="992" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="151" value="RMSNorm" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="992" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="152" value="LayerNorm" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="992" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="153" value="LayerNorm" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="992" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="154" value="Norm Dim" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=8;fontStyle=1;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="1022" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="155" value="1280 (pre-merge)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3949ab;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="1022" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="156" value="1152 (pre-merge)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3949ab;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="1022" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="157" value="4608 (post-merge)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3949ab;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="1022" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="158" value="Norm Order" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=8;fontStyle=1;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="1052" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="159" value="Norm → Merge → MLP" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3949ab;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="1052" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="160" value="Norm → Merge → MLP" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3949ab;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="1052" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="161" value="Merge → Norm → MLP" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3949ab;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="1052" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="162" value="ViT Width" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=8;fontStyle=1;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="1082" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="163" value="1280" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="1082" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="164" value="1152" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="1082" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="165" value="1152" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="1082" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="166" value="Merged Dim" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=8;fontStyle=1;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="1112" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="167" value="4×1280 = 5120" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="1112" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="168" value="4×1152 = 4608" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="1112" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="169" value="4×1152 = 4608" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="1112" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="170" value="Output Dim" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=8;fontStyle=1;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="1142" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="171" value="3584 (LLM hidden)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="1142" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="172" value="3584 (LLM hidden)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="1142" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="173" value="3584 (LLM hidden)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="1142" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="174" value="Activation" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=8;fontStyle=1;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="1172" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="175" value="nn.GELU()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="1172" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="176" value="nn.GELU()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="1172" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="177" value="nn.GELU()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="1172" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="178" value="Destination" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=8;fontStyle=1;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="1202" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="179" value="LLM input tokens" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="1202" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="180" value="LLM input tokens" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="1202" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="181" value="LLM layers 0,1,2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="1202" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="182" value="Source Block" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1565c0;fontSize=8;fontStyle=1;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="1232" width="155" height="28" as="geometry"/></mxCell>
<mxCell id="183" value="Block 31 (last)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="187" y="1232" width="175" height="28" as="geometry"/></mxCell>
<mxCell id="184" value="Block 26 (last)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="364" y="1232" width="195" height="28" as="geometry"/></mxCell>
<mxCell id="185" value="Blocks 8, 16, 24" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f0f0f0;strokeColor=#999999;fontSize=8;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="561" y="1232" width="210" height="28" as="geometry"/></mxCell>
<mxCell id="186" value="★ Key Differences: (1) RMSNorm → LayerNorm  (2) DeepStack mergers normalize AFTER spatial merge (dim=4608 vs 1152)  (3) 3 additional mergers for multi-scale feature injection" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3949ab;fontSize=9;fontStyle=0;arcSize=8;verticalAlign=middle;align=center;" vertex="1" parent="1"><mxGeometry x="30" y="1267" width="741" height="38" as="geometry"/></mxCell>
</root>
</mxGraphModel>
</diagram>
</mxfile>