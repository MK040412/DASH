<?xml version="1.0" ?>
<mxfile host="app.diagrams.net">
  <diagram name="PatchMerger Detail" id="patchmerger">
    <mxGraphModel dx="1600" dy="1000" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1100" background="#FFFFFF">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Title -->
        <mxCell id="t1" style="text;html=1;align=left;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=14;fontColor=#333333;fontStyle=1;" parent="1" value="Qwen3-VL PatchMerger — Internal Operation Detail" vertex="1">
          <mxGeometry x="20" y="10" width="600" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="t2" style="text;html=1;align=left;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=9;fontColor=#999999;fontStyle=0;" parent="1" value="Source: Qwen3VLVisionPatchMerger (modeling_qwen3_vl.py)" vertex="1">
          <mxGeometry x="20" y="34" width="400" height="16" as="geometry"/>
        </mxCell>

        <!-- ============================================ -->
        <!-- (a) Final PatchMerger Panel -->
        <!-- ============================================ -->
        <mxCell id="pa_bg" style="rounded=1;arcSize=4;whiteSpace=wrap;html=1;fillColor=#F0FFF0;strokeColor=#82B366;strokeWidth=1.5;opacity=30;fontSize=12;fontColor=#555555;verticalAlign=top;fontStyle=1;" parent="1" value="  (a) Final PatchMerger (use_postshuffle_norm = False)" vertex="1">
          <mxGeometry x="30" y="60" width="400" height="980" as="geometry"/>
        </mxCell>

        <!-- Input from ViT -->
        <mxCell id="a_in" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#E6E6E6;strokeColor=#666666;fontSize=10;fontStyle=1;strokeWidth=1.5;" parent="1" value="ViT Block 27 Output&lt;br&gt;&lt;font style='font-weight:normal;font-size:9px;color:#888888'&gt;(N, 1152)&lt;/font&gt;" vertex="1">
          <mxGeometry x="110" y="100" width="260" height="40" as="geometry"/>
        </mxCell>

        <!-- Dimension annotation -->
        <mxCell id="a_dim0" style="text;html=1;align=left;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#888888;fontStyle=0;" parent="1" value="예: 224×224 이미지 → N=196 patches (14×14)" vertex="1">
          <mxGeometry x="110" y="140" width="260" height="14" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="a_e1" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="240" y="155" as="sourcePoint"/>
            <mxPoint x="240" y="180" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Step 1: LayerNorm -->
        <mxCell id="a_ln" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#FFF2CC;strokeColor=#D6B656;fontSize=10;fontStyle=0;strokeWidth=1.5;" parent="1" value="&lt;b&gt;LayerNorm&lt;/b&gt;(1152, eps=1e-6)&lt;br&gt;&lt;font style='font-size:8px;color:#888888'&gt;learnable γ, β&lt;/font&gt;" vertex="1">
          <mxGeometry x="110" y="180" width="260" height="42" as="geometry"/>
        </mxCell>
        <mxCell id="a_ln_eq" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#D6B656;fontStyle=2;" parent="1" value="LN(x) = γ · (x − μ) / √(σ² + ε) + β" vertex="1">
          <mxGeometry x="110" y="222" width="260" height="14" as="geometry"/>
        </mxCell>
        <mxCell id="a_ln_dim" style="text;html=1;align=right;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#888888;fontStyle=0;" parent="1" value="(N, 1152)" vertex="1">
          <mxGeometry x="370" y="185" width="55" height="14" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="a_e2" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="240" y="240" as="sourcePoint"/>
            <mxPoint x="240" y="270" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Step 2: 2×2 Spatial Merge -->
        <mxCell id="a_merge_bg" style="rounded=1;arcSize=6;whiteSpace=wrap;html=1;fillColor=#E8EEFF;strokeColor=#6C8EBF;strokeWidth=1.5;opacity=50;fontSize=10;fontColor=#555555;verticalAlign=top;fontStyle=1;" parent="1" value="  2×2 Spatial Merge" vertex="1">
          <mxGeometry x="60" y="270" width="340" height="290" as="geometry"/>
        </mxCell>

        <!-- Grid visualization -->
        <!-- Before merge: 14×14 grid -->
        <mxCell id="a_grid_title" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=9;fontColor=#6C8EBF;fontStyle=1;" parent="1" value="Before: 14×14 = 196 patches" vertex="1">
          <mxGeometry x="70" y="295" width="150" height="16" as="geometry"/>
        </mxCell>

        <!-- 4×4 grid (simplified) showing 2×2 grouping -->
        <mxCell id="g1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₀" vertex="1">
          <mxGeometry x="90" y="315" width="32" height="32" as="geometry"/>
        </mxCell>
        <mxCell id="g2" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₁" vertex="1">
          <mxGeometry x="122" y="315" width="32" height="32" as="geometry"/>
        </mxCell>
        <mxCell id="g3" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₂" vertex="1">
          <mxGeometry x="154" y="315" width="32" height="32" as="geometry"/>
        </mxCell>
        <mxCell id="g4" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₃" vertex="1">
          <mxGeometry x="186" y="315" width="32" height="32" as="geometry"/>
        </mxCell>

        <mxCell id="g5" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₄" vertex="1">
          <mxGeometry x="90" y="347" width="32" height="32" as="geometry"/>
        </mxCell>
        <mxCell id="g6" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₅" vertex="1">
          <mxGeometry x="122" y="347" width="32" height="32" as="geometry"/>
        </mxCell>
        <mxCell id="g7" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₆" vertex="1">
          <mxGeometry x="154" y="347" width="32" height="32" as="geometry"/>
        </mxCell>
        <mxCell id="g8" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₇" vertex="1">
          <mxGeometry x="186" y="347" width="32" height="32" as="geometry"/>
        </mxCell>

        <!-- 2×2 grouping box -->
        <mxCell id="g_box1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#6C8EBF;fontSize=7;fontStyle=0;strokeWidth=3;dashed=1;dashPattern=4 2;" parent="1" value="" vertex="1">
          <mxGeometry x="88" y="313" width="68" height="68" as="geometry"/>
        </mxCell>
        <mxCell id="g_box2" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=3;dashed=1;dashPattern=4 2;" parent="1" value="" vertex="1">
          <mxGeometry x="152" y="313" width="68" height="68" as="geometry"/>
        </mxCell>

        <!-- ... dots -->
        <mxCell id="g_dots" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=14;fontColor=#888888;fontStyle=1;" parent="1" value="···" vertex="1">
          <mxGeometry x="222" y="340" width="30" height="20" as="geometry"/>
        </mxCell>

        <!-- Concat arrow -->
        <mxCell id="a_concat_arrow" style="html=1;strokeColor=#6C8EBF;endArrow=blockThin;endFill=1;strokeWidth=2;curved=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="155" y="385" as="sourcePoint"/>
            <mxPoint x="155" y="420" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="a_concat_label" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#6C8EBF;fontStyle=1;" parent="1" value="Concat" vertex="1">
          <mxGeometry x="162" y="393" width="40" height="14" as="geometry"/>
        </mxCell>

        <!-- After merge: concatenated -->
        <mxCell id="a_merged1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=6;fontStyle=0;strokeWidth=1;" parent="1" value="p₀" vertex="1">
          <mxGeometry x="80" y="425" width="28" height="22" as="geometry"/>
        </mxCell>
        <mxCell id="a_merged2" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=6;fontStyle=0;strokeWidth=1;" parent="1" value="p₁" vertex="1">
          <mxGeometry x="108" y="425" width="28" height="22" as="geometry"/>
        </mxCell>
        <mxCell id="a_merged3" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=6;fontStyle=0;strokeWidth=1;" parent="1" value="p₄" vertex="1">
          <mxGeometry x="136" y="425" width="28" height="22" as="geometry"/>
        </mxCell>
        <mxCell id="a_merged4" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=6;fontStyle=0;strokeWidth=1;" parent="1" value="p₅" vertex="1">
          <mxGeometry x="164" y="425" width="28" height="22" as="geometry"/>
        </mxCell>
        <mxCell id="a_merged_box" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#6C8EBF;fontSize=7;fontStyle=0;strokeWidth=2;" parent="1" value="" vertex="1">
          <mxGeometry x="78" y="423" width="116" height="26" as="geometry"/>
        </mxCell>
        <mxCell id="a_merged_label" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#6C8EBF;fontStyle=1;" parent="1" value="= 1 merged token" vertex="1">
          <mxGeometry x="196" y="425" width="90" height="22" as="geometry"/>
        </mxCell>

        <!-- Reshape equation -->
        <mxCell id="a_reshape" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#E1D5E7;strokeColor=#9673A6;fontSize=9;fontStyle=0;strokeWidth=1.5;" parent="1" value="&lt;b&gt;Reshape&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:8px'&gt;.view(-1, 1152 × 2²)&lt;/font&gt;" vertex="1">
          <mxGeometry x="110" y="475" width="240" height="36" as="geometry"/>
        </mxCell>
        <mxCell id="a_reshape_out" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=9;fontColor=#9673A6;fontStyle=1;" parent="1" value="(N, 1152) → (N/4, 4608)" vertex="1">
          <mxGeometry x="110" y="511" width="240" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="a_reshape_detail" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=7;fontColor=#888888;fontStyle=0;" parent="1" value="196 tokens × 1152 dim → 49 tokens × 4608 dim&lt;br&gt;(4608 = 1152 × 4, 인접 2×2 패치 4개 concat)" vertex="1">
          <mxGeometry x="80" y="527" width="300" height="22" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="a_e3" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="240" y="555" as="sourcePoint"/>
            <mxPoint x="240" y="580" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Step 3: Linear FC1 -->
        <mxCell id="a_fc1" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#FFE6CC;strokeColor=#D79B00;fontSize=10;fontStyle=0;strokeWidth=1.5;" parent="1" value="&lt;b&gt;Linear&lt;/b&gt; (4608 → 4608)&lt;br&gt;&lt;font style='font-size:8px;color:#888888'&gt;nn.Linear(4608, 4608, bias=True)&lt;/font&gt;" vertex="1">
          <mxGeometry x="110" y="580" width="260" height="42" as="geometry"/>
        </mxCell>
        <mxCell id="a_fc1_dim" style="text;html=1;align=right;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#888888;fontStyle=0;" parent="1" value="(N/4, 4608)" vertex="1">
          <mxGeometry x="370" y="585" width="55" height="14" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="a_e4" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="240" y="625" as="sourcePoint"/>
            <mxPoint x="240" y="650" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Step 4: GELU -->
        <mxCell id="a_gelu" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;fontSize=10;fontStyle=0;strokeWidth=1.5;" parent="1" value="&lt;b&gt;GELU&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:7px;color:#888888'&gt;nn.GELU() (standard, not tanh approx)&lt;/font&gt;" vertex="1">
          <mxGeometry x="110" y="650" width="260" height="40" as="geometry"/>
        </mxCell>
        <mxCell id="a_gelu_dim" style="text;html=1;align=right;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#888888;fontStyle=0;" parent="1" value="(N/4, 4608)" vertex="1">
          <mxGeometry x="370" y="655" width="55" height="14" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="a_e5" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="240" y="693" as="sourcePoint"/>
            <mxPoint x="240" y="720" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Step 5: Linear FC2 -->
        <mxCell id="a_fc2" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#FFE6CC;strokeColor=#D79B00;fontSize=10;fontStyle=0;strokeWidth=1.5;" parent="1" value="&lt;b&gt;Linear&lt;/b&gt; (4608 → 3584)&lt;br&gt;&lt;font style='font-size:8px;color:#888888'&gt;nn.Linear(4608, 3584, bias=True)&lt;/font&gt;" vertex="1">
          <mxGeometry x="110" y="720" width="260" height="42" as="geometry"/>
        </mxCell>
        <mxCell id="a_fc2_dim" style="text;html=1;align=right;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#D79B00;fontStyle=1;" parent="1" value="(N/4, 3584)" vertex="1">
          <mxGeometry x="370" y="725" width="55" height="14" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="a_e6" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="240" y="765" as="sourcePoint"/>
            <mxPoint x="240" y="795" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Output -->
        <mxCell id="a_out" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;fontSize=11;fontStyle=1;strokeWidth=2;" parent="1" value="visual_tokens&lt;br&gt;&lt;font style='font-weight:normal;font-size:9px;color:#555555'&gt;(49, 3584)&lt;/font&gt;" vertex="1">
          <mxGeometry x="130" y="795" width="220" height="42" as="geometry"/>
        </mxCell>
        <mxCell id="a_out_label" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#82B366;fontStyle=1;" parent="1" value="→ LLM [IMG] 위치에 삽입" vertex="1">
          <mxGeometry x="130" y="837" width="220" height="14" as="geometry"/>
        </mxCell>

        <!-- Summary equation -->
        <mxCell id="a_summary" style="rounded=1;arcSize=8;whiteSpace=wrap;html=1;fillColor=#FFFDE7;strokeColor=#D6B656;strokeWidth=1;fontSize=8;fontStyle=0;" parent="1" value="&lt;b&gt;Summary:&lt;/b&gt;&lt;br&gt;(N, 1152) →&lt;font color='#D6B656'&gt; LN&lt;/font&gt; → merge(2×2) → (N/4, 4608) →&lt;font color='#D79B00'&gt; FC&lt;/font&gt; →&lt;font color='#82B366'&gt; GELU&lt;/font&gt; →&lt;font color='#D79B00'&gt; FC&lt;/font&gt; → (N/4, 3584)" vertex="1">
          <mxGeometry x="60" y="870" width="350" height="40" as="geometry"/>
        </mxCell>

        <!-- Code snippet -->
        <mxCell id="a_code" style="rounded=1;arcSize=6;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#CCCCCC;strokeWidth=1;fontSize=7;fontStyle=0;fontFamily=monospace;align=left;" parent="1" value="&lt;font color='#999999'&gt;# use_postshuffle_norm = False&lt;/font&gt;&lt;br&gt;self.norm = LayerNorm(&lt;font color='#D79B00'&gt;1152&lt;/font&gt;, eps=1e-6)&lt;br&gt;self.linear_fc1 = Linear(&lt;font color='#D79B00'&gt;4608&lt;/font&gt;, &lt;font color='#D79B00'&gt;4608&lt;/font&gt;)&lt;br&gt;self.act_fn = GELU()&lt;br&gt;self.linear_fc2 = Linear(&lt;font color='#D79B00'&gt;4608&lt;/font&gt;, &lt;font color='#82B366'&gt;3584&lt;/font&gt;)" vertex="1">
          <mxGeometry x="60" y="920" width="350" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="a_code_note" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=7;fontColor=#888888;fontStyle=2;" parent="1" value="* LN이 merge 전에 적용됨 (dim=1152)" vertex="1">
          <mxGeometry x="60" y="992" width="350" height="14" as="geometry"/>
        </mxCell>


        <!-- ============================================ -->
        <!-- (b) DeepStack PatchMerger Panel -->
        <!-- ============================================ -->
        <mxCell id="pb_bg" style="rounded=1;arcSize=4;whiteSpace=wrap;html=1;fillColor=#FFF5F5;strokeColor=#B85450;strokeWidth=1.5;opacity=30;fontSize=12;fontColor=#555555;verticalAlign=top;fontStyle=1;" parent="1" value="  (b) DeepStack PatchMerger (use_postshuffle_norm = True)" vertex="1">
          <mxGeometry x="470" y="60" width="400" height="980" as="geometry"/>
        </mxCell>

        <!-- Input from ViT intermediate -->
        <mxCell id="b_in" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=10;fontStyle=1;strokeWidth=1.5;" parent="1" value="ViT Block l Output (l ∈ {8, 16, 24})&lt;br&gt;&lt;font style='font-weight:normal;font-size:9px;color:#888888'&gt;(N, 1152)&lt;/font&gt;" vertex="1">
          <mxGeometry x="540" y="100" width="280" height="40" as="geometry"/>
        </mxCell>

        <mxCell id="b_dim0" style="text;html=1;align=left;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#888888;fontStyle=0;" parent="1" value="중간 레이어에서 추출 (multi-scale features)" vertex="1">
          <mxGeometry x="540" y="140" width="280" height="14" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="b_e1" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="680" y="155" as="sourcePoint"/>
            <mxPoint x="680" y="180" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Step 1: 2×2 Spatial Merge (FIRST, before LN) -->
        <mxCell id="b_merge_bg" style="rounded=1;arcSize=6;whiteSpace=wrap;html=1;fillColor=#FCE4EC;strokeColor=#B85450;strokeWidth=1.5;opacity=50;fontSize=10;fontColor=#555555;verticalAlign=top;fontStyle=1;" parent="1" value="  2×2 Spatial Merge (먼저)" vertex="1">
          <mxGeometry x="500" y="180" width="340" height="210" as="geometry"/>
        </mxCell>

        <!-- Grid visualization (compact) -->
        <mxCell id="b_grid_title" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=9;fontColor=#B85450;fontStyle=1;" parent="1" value="인접 2×2 패치 → Concat" vertex="1">
          <mxGeometry x="510" y="205" width="200" height="16" as="geometry"/>
        </mxCell>

        <!-- Before merge patches -->
        <mxCell id="bg1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₀" vertex="1">
          <mxGeometry x="530" y="230" width="30" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="bg2" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₁" vertex="1">
          <mxGeometry x="560" y="230" width="30" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="bg3" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₂" vertex="1">
          <mxGeometry x="530" y="260" width="30" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="bg4" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="p₃" vertex="1">
          <mxGeometry x="560" y="260" width="30" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="b_gbox" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=3;dashed=1;dashPattern=4 2;" parent="1" value="" vertex="1">
          <mxGeometry x="528" y="228" width="64" height="64" as="geometry"/>
        </mxCell>

        <!-- Arrow to merged -->
        <mxCell id="b_garrow" style="html=1;strokeColor=#B85450;endArrow=blockThin;endFill=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="595" y="260" as="sourcePoint"/>
            <mxPoint x="630" y="260" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Merged single vector -->
        <mxCell id="b_merged_vec" style="rounded=1;arcSize=8;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=1;strokeWidth=1.5;" parent="1" value="[p₀ ; p₁ ; p₂ ; p₃]&lt;br&gt;&lt;font style='font-weight:normal;font-size:7px;color:#888888'&gt;4 × 1152 = 4608 dim&lt;/font&gt;" vertex="1">
          <mxGeometry x="633" y="238" width="160" height="44" as="geometry"/>
        </mxCell>

        <!-- Reshape -->
        <mxCell id="b_reshape" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#E1D5E7;strokeColor=#9673A6;fontSize=9;fontStyle=0;strokeWidth=1.5;" parent="1" value="&lt;b&gt;Reshape&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:8px'&gt;.view(-1, 1152 × 2²)&lt;/font&gt;" vertex="1">
          <mxGeometry x="540" y="310" width="260" height="36" as="geometry"/>
        </mxCell>
        <mxCell id="b_reshape_out" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=9;fontColor=#9673A6;fontStyle=1;" parent="1" value="(N, 1152) → (N/4, 4608)" vertex="1">
          <mxGeometry x="540" y="346" width="260" height="16" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="b_e2" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="680" y="400" as="sourcePoint"/>
            <mxPoint x="680" y="435" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Step 2: LayerNorm (AFTER merge) -->
        <mxCell id="b_ln" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#FFF2CC;strokeColor=#D6B656;fontSize=10;fontStyle=0;strokeWidth=1.5;" parent="1" value="&lt;b&gt;LayerNorm&lt;/b&gt;(&lt;font color='#B85450'&gt;&lt;b&gt;4608&lt;/b&gt;&lt;/font&gt;, eps=1e-6)&lt;br&gt;&lt;font style='font-size:8px;color:#888888'&gt;learnable γ, β — merge 후에 LN!&lt;/font&gt;" vertex="1">
          <mxGeometry x="540" y="435" width="260" height="42" as="geometry"/>
        </mxCell>
        <mxCell id="b_ln_dim" style="text;html=1;align=right;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#888888;fontStyle=0;" parent="1" value="(N/4, 4608)" vertex="1">
          <mxGeometry x="800" y="440" width="60" height="14" as="geometry"/>
        </mxCell>

        <!-- KEY DIFFERENCE callout -->
        <mxCell id="b_diff" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#B85450;fontSize=8;fontStyle=1;strokeWidth=2;" parent="1" value="⚠ 핵심 차이: LN(4608)&lt;br&gt;&lt;font style='font-weight:normal;font-size:7px'&gt;Final은 LN(1152) 후 merge&lt;br&gt;DeepStack은 merge 후 LN(4608)&lt;/font&gt;" vertex="1">
          <mxGeometry x="490" y="488" width="180" height="44" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="b_e3" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="680" y="540" as="sourcePoint"/>
            <mxPoint x="680" y="575" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Step 3: Linear FC1 -->
        <mxCell id="b_fc1" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#FFE6CC;strokeColor=#D79B00;fontSize=10;fontStyle=0;strokeWidth=1.5;" parent="1" value="&lt;b&gt;Linear&lt;/b&gt; (4608 → 4608)&lt;br&gt;&lt;font style='font-size:8px;color:#888888'&gt;nn.Linear(4608, 4608, bias=True)&lt;/font&gt;" vertex="1">
          <mxGeometry x="540" y="575" width="260" height="42" as="geometry"/>
        </mxCell>
        <mxCell id="b_fc1_dim" style="text;html=1;align=right;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#888888;fontStyle=0;" parent="1" value="(N/4, 4608)" vertex="1">
          <mxGeometry x="800" y="580" width="60" height="14" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="b_e4" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="680" y="620" as="sourcePoint"/>
            <mxPoint x="680" y="650" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Step 4: GELU -->
        <mxCell id="b_gelu" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;fontSize=10;fontStyle=0;strokeWidth=1.5;" parent="1" value="&lt;b&gt;GELU&lt;/b&gt;&lt;br&gt;&lt;font style='font-size:7px;color:#888888'&gt;nn.GELU()&lt;/font&gt;" vertex="1">
          <mxGeometry x="540" y="650" width="260" height="40" as="geometry"/>
        </mxCell>
        <mxCell id="b_gelu_dim" style="text;html=1;align=right;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#888888;fontStyle=0;" parent="1" value="(N/4, 4608)" vertex="1">
          <mxGeometry x="800" y="655" width="60" height="14" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="b_e5" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="680" y="693" as="sourcePoint"/>
            <mxPoint x="680" y="720" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Step 5: Linear FC2 -->
        <mxCell id="b_fc2" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#FFE6CC;strokeColor=#D79B00;fontSize=10;fontStyle=0;strokeWidth=1.5;" parent="1" value="&lt;b&gt;Linear&lt;/b&gt; (4608 → 3584)&lt;br&gt;&lt;font style='font-size:8px;color:#888888'&gt;nn.Linear(4608, 3584, bias=True)&lt;/font&gt;" vertex="1">
          <mxGeometry x="540" y="720" width="260" height="42" as="geometry"/>
        </mxCell>
        <mxCell id="b_fc2_dim" style="text;html=1;align=right;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#D79B00;fontStyle=1;" parent="1" value="(N/4, 3584)" vertex="1">
          <mxGeometry x="800" y="725" width="60" height="14" as="geometry"/>
        </mxCell>

        <!-- Arrow -->
        <mxCell id="b_e6" style="html=1;strokeColor=#333333;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="680" y="765" as="sourcePoint"/>
            <mxPoint x="680" y="795" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Output -->
        <mxCell id="b_out" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=11;fontStyle=1;strokeWidth=2;" parent="1" value="deepstack_feature F&lt;sup&gt;k&lt;/sup&gt;&lt;br&gt;&lt;font style='font-weight:normal;font-size:9px;color:#555555'&gt;(49, 3584)&lt;/font&gt;" vertex="1">
          <mxGeometry x="570" y="795" width="220" height="42" as="geometry"/>
        </mxCell>
        <mxCell id="b_out_label" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=8;fontColor=#B85450;fontStyle=1;" parent="1" value="→ LLM Decoder Layer 0, 1, 2에 additive injection" vertex="1">
          <mxGeometry x="520" y="837" width="330" height="14" as="geometry"/>
        </mxCell>

        <!-- Summary equation -->
        <mxCell id="b_summary" style="rounded=1;arcSize=8;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#B85450;strokeWidth=1;fontSize=8;fontStyle=0;" parent="1" value="&lt;b&gt;Summary:&lt;/b&gt;&lt;br&gt;(N, 1152) → merge(2×2) → (N/4, 4608) →&lt;font color='#D6B656'&gt; LN&lt;/font&gt; →&lt;font color='#D79B00'&gt; FC&lt;/font&gt; →&lt;font color='#82B366'&gt; GELU&lt;/font&gt; →&lt;font color='#D79B00'&gt; FC&lt;/font&gt; → (N/4, 3584)" vertex="1">
          <mxGeometry x="500" y="870" width="350" height="40" as="geometry"/>
        </mxCell>

        <!-- Code snippet -->
        <mxCell id="b_code" style="rounded=1;arcSize=6;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#CCCCCC;strokeWidth=1;fontSize=7;fontStyle=0;fontFamily=monospace;align=left;" parent="1" value="&lt;font color='#999999'&gt;# use_postshuffle_norm = True&lt;/font&gt;&lt;br&gt;self.norm = LayerNorm(&lt;font color='#B85450'&gt;4608&lt;/font&gt;, eps=1e-6)&lt;br&gt;self.linear_fc1 = Linear(&lt;font color='#D79B00'&gt;4608&lt;/font&gt;, &lt;font color='#D79B00'&gt;4608&lt;/font&gt;)&lt;br&gt;self.act_fn = GELU()&lt;br&gt;self.linear_fc2 = Linear(&lt;font color='#D79B00'&gt;4608&lt;/font&gt;, &lt;font color='#82B366'&gt;3584&lt;/font&gt;)" vertex="1">
          <mxGeometry x="500" y="920" width="350" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="b_code_note" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=7;fontColor=#888888;fontStyle=2;" parent="1" value="* LN이 merge 후에 적용됨 (dim=4608)" vertex="1">
          <mxGeometry x="500" y="992" width="350" height="14" as="geometry"/>
        </mxCell>


        <!-- ============================================ -->
        <!-- (c) Side-by-side Comparison Panel -->
        <!-- ============================================ -->
        <mxCell id="pc_bg" style="rounded=1;arcSize=4;whiteSpace=wrap;html=1;fillColor=#F5F5FF;strokeColor=#6C8EBF;strokeWidth=1.5;opacity=30;fontSize=12;fontColor=#555555;verticalAlign=top;fontStyle=1;" parent="1" value="  (c) Final vs DeepStack — 핵심 차이 비교" vertex="1">
          <mxGeometry x="910" y="60" width="470" height="520" as="geometry"/>
        </mxCell>

        <!-- Table header -->
        <mxCell id="c_h1" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#E6E6E6;strokeColor=#666666;fontSize=9;fontStyle=1;strokeWidth=1.5;" parent="1" value="항목" vertex="1">
          <mxGeometry x="930" y="95" width="100" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="c_h2" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;fontSize=9;fontStyle=1;strokeWidth=1.5;" parent="1" value="Final Merger" vertex="1">
          <mxGeometry x="1032" y="95" width="160" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="c_h3" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=9;fontStyle=1;strokeWidth=1.5;" parent="1" value="DeepStack Merger" vertex="1">
          <mxGeometry x="1194" y="95" width="160" height="24" as="geometry"/>
        </mxCell>

        <!-- Row 1: 사용 위치 -->
        <mxCell id="c_r1a" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#CCCCCC;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="사용 위치" vertex="1">
          <mxGeometry x="930" y="121" width="100" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="c_r1b" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#82B366;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="Block 27 (최종) 후&lt;br&gt;1개" vertex="1">
          <mxGeometry x="1032" y="121" width="160" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="c_r1c" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#B85450;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="Block 8, 16, 24 후&lt;br&gt;3개" vertex="1">
          <mxGeometry x="1194" y="121" width="160" height="30" as="geometry"/>
        </mxCell>

        <!-- Row 2: LN 위치 -->
        <mxCell id="c_r2a" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#CCCCCC;fontSize=8;fontStyle=1;strokeWidth=1;" parent="1" value="LN 위치" vertex="1">
          <mxGeometry x="930" y="153" width="100" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="c_r2b" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#82B366;fontSize=8;fontStyle=1;strokeWidth=1;" parent="1" value="merge 전&lt;br&gt;LN(1152)" vertex="1">
          <mxGeometry x="1032" y="153" width="160" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="c_r2c" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#B85450;fontSize=8;fontStyle=1;strokeWidth=1;" parent="1" value="merge 후&lt;br&gt;LN(4608)" vertex="1">
          <mxGeometry x="1194" y="153" width="160" height="30" as="geometry"/>
        </mxCell>

        <!-- Row 3: postshuffle -->
        <mxCell id="c_r3a" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#CCCCCC;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="postshuffle_norm" vertex="1">
          <mxGeometry x="930" y="185" width="100" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="c_r3b" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#82B366;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="False" vertex="1">
          <mxGeometry x="1032" y="185" width="160" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="c_r3c" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#B85450;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="True" vertex="1">
          <mxGeometry x="1194" y="185" width="160" height="24" as="geometry"/>
        </mxCell>

        <!-- Row 4: 출력 용도 -->
        <mxCell id="c_r4a" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#CCCCCC;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="출력 용도" vertex="1">
          <mxGeometry x="930" y="211" width="100" height="36" as="geometry"/>
        </mxCell>
        <mxCell id="c_r4b" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#82B366;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="LLM input tokens&lt;br&gt;([IMG] 위치 삽입)" vertex="1">
          <mxGeometry x="1032" y="211" width="160" height="36" as="geometry"/>
        </mxCell>
        <mxCell id="c_r4c" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#B85450;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="LLM early layer injection&lt;br&gt;(decoder 0,1,2에 ⊕)" vertex="1">
          <mxGeometry x="1194" y="211" width="160" height="36" as="geometry"/>
        </mxCell>

        <!-- Row 5: 연산 순서 -->
        <mxCell id="c_r5a" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#CCCCCC;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="연산 순서" vertex="1">
          <mxGeometry x="930" y="249" width="100" height="36" as="geometry"/>
        </mxCell>
        <mxCell id="c_r5b" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#82B366;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="LN(1152) → merge → FC → GELU → FC" vertex="1">
          <mxGeometry x="1032" y="249" width="160" height="36" as="geometry"/>
        </mxCell>
        <mxCell id="c_r5c" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="merge → LN(4608) → FC → GELU → FC" vertex="1">
          <mxGeometry x="1194" y="249" width="160" height="36" as="geometry"/>
        </mxCell>

        <!-- Row 6: 입출력 차원 -->
        <mxCell id="c_r6a" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#CCCCCC;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="입출력 차원" vertex="1">
          <mxGeometry x="930" y="287" width="100" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="c_r6b" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#82B366;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="(N, 1152) → (N/4, 3584)" vertex="1">
          <mxGeometry x="1032" y="287" width="160" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="c_r6c" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#B85450;fontSize=8;fontStyle=0;strokeWidth=1;" parent="1" value="(N, 1152) → (N/4, 3584)" vertex="1">
          <mxGeometry x="1194" y="287" width="160" height="24" as="geometry"/>
        </mxCell>

        <!-- Diagram showing order difference -->
        <mxCell id="c_order_title" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=10;fontColor=#333333;fontStyle=1;" parent="1" value="연산 순서 시각화" vertex="1">
          <mxGeometry x="930" y="330" width="430" height="20" as="geometry"/>
        </mxCell>

        <!-- Final merger order -->
        <mxCell id="c_f_title" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=9;fontColor=#82B366;fontStyle=1;" parent="1" value="Final Merger" vertex="1">
          <mxGeometry x="930" y="355" width="200" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="c_f1" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#FFF2CC;strokeColor=#D6B656;fontSize=8;fontStyle=1;strokeWidth=1.5;" parent="1" value="① LN(1152)" vertex="1">
          <mxGeometry x="940" y="375" width="80" height="26" as="geometry"/>
        </mxCell>
        <mxCell id="c_f_arr1" style="html=1;strokeColor=#82B366;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1022" y="388" as="sourcePoint"/>
            <mxPoint x="1040" y="388" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="c_f2" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#E1D5E7;strokeColor=#9673A6;fontSize=8;fontStyle=1;strokeWidth=1.5;" parent="1" value="② Merge" vertex="1">
          <mxGeometry x="1042" y="375" width="70" height="26" as="geometry"/>
        </mxCell>

        <!-- DeepStack merger order -->
        <mxCell id="c_d_title" style="text;html=1;align=center;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=9;fontColor=#B85450;fontStyle=1;" parent="1" value="DeepStack Merger" vertex="1">
          <mxGeometry x="930" y="415" width="200" height="16" as="geometry"/>
        </mxCell>
        <mxCell id="c_d1" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#E1D5E7;strokeColor=#9673A6;fontSize=8;fontStyle=1;strokeWidth=1.5;" parent="1" value="① Merge" vertex="1">
          <mxGeometry x="940" y="435" width="70" height="26" as="geometry"/>
        </mxCell>
        <mxCell id="c_d_arr1" style="html=1;strokeColor=#B85450;endArrow=blockThin;endFill=1;strokeWidth=1.5;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1012" y="448" as="sourcePoint"/>
            <mxPoint x="1040" y="448" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="c_d2" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#FFF2CC;strokeColor=#D6B656;fontSize=8;fontStyle=1;strokeWidth=1.5;" parent="1" value="② LN(4608)" vertex="1">
          <mxGeometry x="1042" y="435" width="80" height="26" as="geometry"/>
        </mxCell>

        <!-- Why different? -->
        <mxCell id="c_why" style="rounded=1;arcSize=8;whiteSpace=wrap;html=1;fillColor=#FFFDE7;strokeColor=#D6B656;strokeWidth=1;fontSize=8;fontStyle=0;" parent="1" value="&lt;b&gt;왜 순서가 다른가?&lt;/b&gt;&lt;br&gt;• Final: per-token normalization 후 병합 → 각 패치의 스케일을 먼저 정규화&lt;br&gt;• DeepStack: 병합 후 joint normalization → concat된 4개 패치 간의 관계를 반영" vertex="1">
          <mxGeometry x="930" y="480" width="430" height="50" as="geometry"/>
        </mxCell>

        <!-- ============================================ -->
        <!-- (d) Where in ViT Panel -->
        <!-- ============================================ -->
        <mxCell id="pd_bg" style="rounded=1;arcSize=4;whiteSpace=wrap;html=1;fillColor=#FFF8E1;strokeColor=#D6B656;strokeWidth=1.5;opacity=30;fontSize=12;fontColor=#555555;verticalAlign=top;fontStyle=1;" parent="1" value="  (d) Vision Encoder 내 PatchMerger 위치" vertex="1">
          <mxGeometry x="910" y="600" width="470" height="430" as="geometry"/>
        </mxCell>

        <!-- Mini ViT diagram -->
        <mxCell id="d_b07" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=8;fontStyle=0;strokeWidth=1.5;" parent="1" value="Block 0–7 (×8)" vertex="1">
          <mxGeometry x="1000" y="640" width="120" height="28" as="geometry"/>
        </mxCell>
        <mxCell id="d_b8" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=8;fontStyle=1;strokeWidth=1.5;" parent="1" value="Block 8" vertex="1">
          <mxGeometry x="1000" y="675" width="120" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="d_e1" style="html=1;strokeColor=#999999;endArrow=blockThin;endFill=1;strokeWidth=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1060" y="668" as="sourcePoint"/>
            <mxPoint x="1060" y="675" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="d_m0" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="DS Merger₀" vertex="1">
          <mxGeometry x="1170" y="675" width="100" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="d_m0_arr" style="html=1;strokeColor=#B85450;endArrow=blockThin;endFill=1;strokeWidth=1.5;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" edge="1" source="d_b8" target="d_m0">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="d_m0_out" style="text;html=1;align=left;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=7;fontColor=#B85450;fontStyle=0;" parent="1" value="→ F⁰" vertex="1">
          <mxGeometry x="1272" y="678" width="40" height="18" as="geometry"/>
        </mxCell>

        <mxCell id="d_b915" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=8;fontStyle=0;strokeWidth=1.5;" parent="1" value="Block 9–15 (×7)" vertex="1">
          <mxGeometry x="1000" y="708" width="120" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="d_b16" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=8;fontStyle=1;strokeWidth=1.5;" parent="1" value="Block 16" vertex="1">
          <mxGeometry x="1000" y="740" width="120" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="d_m1" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="DS Merger₁" vertex="1">
          <mxGeometry x="1170" y="740" width="100" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="d_m1_arr" style="html=1;strokeColor=#B85450;endArrow=blockThin;endFill=1;strokeWidth=1.5;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" edge="1" source="d_b16" target="d_m1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="d_m1_out" style="text;html=1;align=left;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=7;fontColor=#B85450;fontStyle=0;" parent="1" value="→ F¹" vertex="1">
          <mxGeometry x="1272" y="743" width="40" height="18" as="geometry"/>
        </mxCell>

        <mxCell id="d_b1723" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=8;fontStyle=0;strokeWidth=1.5;" parent="1" value="Block 17–23 (×7)" vertex="1">
          <mxGeometry x="1000" y="772" width="120" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="d_b24" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=8;fontStyle=1;strokeWidth=1.5;" parent="1" value="Block 24" vertex="1">
          <mxGeometry x="1000" y="804" width="120" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="d_m2" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#F8CECC;strokeColor=#B85450;fontSize=7;fontStyle=0;strokeWidth=1;" parent="1" value="DS Merger₂" vertex="1">
          <mxGeometry x="1170" y="804" width="100" height="24" as="geometry"/>
        </mxCell>
        <mxCell id="d_m2_arr" style="html=1;strokeColor=#B85450;endArrow=blockThin;endFill=1;strokeWidth=1.5;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" edge="1" source="d_b24" target="d_m2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="d_m2_out" style="text;html=1;align=left;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=7;fontColor=#B85450;fontStyle=0;" parent="1" value="→ F²" vertex="1">
          <mxGeometry x="1272" y="807" width="40" height="18" as="geometry"/>
        </mxCell>

        <mxCell id="d_b2526" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;fontSize=8;fontStyle=0;strokeWidth=1.5;" parent="1" value="Block 25–26 (×2)" vertex="1">
          <mxGeometry x="1000" y="836" width="120" height="24" as="geometry"/>
        </mxCell>

        <!-- Final PatchMerger -->
        <mxCell id="d_fm" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;fontSize=8;fontStyle=1;strokeWidth=2;" parent="1" value="Final PatchMerger" vertex="1">
          <mxGeometry x="1000" y="875" width="120" height="28" as="geometry"/>
        </mxCell>

        <!-- Arrows for ViT flow -->
        <mxCell id="d_ve1" style="html=1;strokeColor=#999999;endArrow=blockThin;endFill=1;strokeWidth=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1060" y="699" as="sourcePoint"/>
            <mxPoint x="1060" y="708" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="d_ve2" style="html=1;strokeColor=#999999;endArrow=blockThin;endFill=1;strokeWidth=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1060" y="732" as="sourcePoint"/>
            <mxPoint x="1060" y="740" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="d_ve3" style="html=1;strokeColor=#999999;endArrow=blockThin;endFill=1;strokeWidth=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1060" y="764" as="sourcePoint"/>
            <mxPoint x="1060" y="772" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="d_ve4" style="html=1;strokeColor=#999999;endArrow=blockThin;endFill=1;strokeWidth=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1060" y="828" as="sourcePoint"/>
            <mxPoint x="1060" y="836" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        <mxCell id="d_ve5" style="html=1;strokeColor=#82B366;endArrow=blockThin;endFill=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1060" y="860" as="sourcePoint"/>
            <mxPoint x="1060" y="875" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Output labels -->
        <mxCell id="d_out" style="rounded=1;arcSize=12;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;fontSize=8;fontStyle=1;strokeWidth=1.5;" parent="1" value="visual_tokens (49, 3584)" vertex="1">
          <mxGeometry x="975" y="915" width="170" height="22" as="geometry"/>
        </mxCell>
        <mxCell id="d_out_arr" style="html=1;strokeColor=#82B366;endArrow=blockThin;endFill=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1060" y="903" as="sourcePoint"/>
            <mxPoint x="1060" y="915" as="targetPoint"/>
          </mxGeometry>
        </mxCell>

        <!-- Feature level annotations -->
        <mxCell id="d_level0" style="text;html=1;align=left;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=7;fontColor=#888888;fontStyle=2;" parent="1" value="저수준 (edge, texture)" vertex="1">
          <mxGeometry x="1305" y="678" width="110" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="d_level1" style="text;html=1;align=left;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=7;fontColor=#888888;fontStyle=2;" parent="1" value="중수준 (object parts)" vertex="1">
          <mxGeometry x="1305" y="743" width="110" height="18" as="geometry"/>
        </mxCell>
        <mxCell id="d_level2" style="text;html=1;align=left;verticalAlign=middle;strokeColor=none;fillColor=none;fontSize=7;fontColor=#888888;fontStyle=2;" parent="1" value="고수준 (semantics)" vertex="1">
          <mxGeometry x="1305" y="807" width="110" height="18" as="geometry"/>
        </mxCell>

        <!-- Parameters summary -->
        <mxCell id="d_params" style="rounded=1;arcSize=8;whiteSpace=wrap;html=1;fillColor=#FFFDE7;strokeColor=#D6B656;strokeWidth=1;fontSize=7;fontStyle=0;" parent="1" value="&lt;b&gt;파라미터:&lt;/b&gt; hidden_size=1152, out_hidden_size=3584, spatial_merge_size=2&lt;br&gt;&lt;b&gt;토큰 수:&lt;/b&gt; N=196 (14×14) → N/4=49 (7×7) for 224×224 input&lt;br&gt;&lt;b&gt;DeepStack indexes:&lt;/b&gt; [8, 16, 24]&lt;br&gt;&lt;b&gt;PatchMerger 총 4개:&lt;/b&gt; 3 DeepStack (postshuffle) + 1 Final" vertex="1">
          <mxGeometry x="930" y="950" width="430" height="56" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
